# Define connection details
$primaryServer   = "ATLDB01P"
$secondaryServer = "ATLDB02P"
$database        = "DBA"
$table           = "LoginsInfo"
set-dbatoolsconfig  -fullname 'sql.connection.trustcert'  -value $true
# Function: Populate LoginsInfo table on both servers
function Refresh-LoginsInfo {
    param ($server)
    Invoke-Sqlcmd -ServerInstance $server -Query "
        USE [$database];
        TRUNCATE TABLE [$table];
        INSERT INTO [$table] (SERVERNAME, name, sid, type_desc, create_date, modify_date)
        SELECT 
            SERVERNAME = @@SERVERNAME,
            name,
            sid,
            type_desc,
            create_date,
            modify_date
        FROM sys.server_principals
        WHERE type IN ('S', 'U', 'G'/*, 'C', 'K'*/) 
        AND name NOT LIKE '##%'
        AND name NOT LIKE 'NT %'
        AND name NOT LIKE 'BUILTIN%'
       -- AND type_desc NOT IN ('SERVER_ROLE', 'CERTIFICATE_MAPPED_LOGIN')
-- sql login, window login, windowgroup, certificate, asymmetric key
    "
}

# Step A: Repopulate LoginsInfo on both servers
Refresh-LoginsInfo -server $primaryServer
Refresh-LoginsInfo -server $secondaryServer

# Step B: Get logins info from both servers
$primaryLogins   = Invoke-Sqlcmd -ServerInstance $primaryServer -Query "SELECT * FROM $database.dbo.$table"
$secondaryLogins = Invoke-Sqlcmd -ServerInstance $secondaryServer -Query "SELECT * FROM $database.dbo.$table"

# Step C: Compare Logins
$missingInSecondary = $primaryLogins  | Where-Object { $_.name -notin $secondaryLogins.name }
$missingInPrimary   = $secondaryLogins | Where-Object { $_.name -notin $primaryLogins.name }

# Step D: Output results
Write-Host "`nLogins present in ${primaryServer} but missing in ${secondaryServer}:" -ForegroundColor Cyan
$missingInSecondary | Format-Table SERVERNAME, name, type_desc, create_date, modify_date

Write-Host "`nLogins present in ${secondaryServer} but missing in ${primaryServer}:" -ForegroundColor Yellow
$missingInPrimary | Format-Table SERVERNAME, name, type_desc, create_date, modify_date
